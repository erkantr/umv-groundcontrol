<!DOCTYPE html>
<html>
<head>
    <title>GCS HaritasÄ±</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS ve JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- QWebChannel iÃ§in gerekli JavaScript -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        var map = L.map('map').setView([41.015137, 28.979530], 13); // Ä°stanbul baÅŸlangÄ±Ã§ noktasÄ±
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 22,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        
        var vehicleMarker = null;
        var waypoints = [];
        var missionPath = null;
        var autoFollow = true; // Otomatik takip aktif mi?
        var firstConnection = true; // Ä°lk baÄŸlantÄ± mÄ±?
        
        // AraÃ§ ikonu (Emoji kullanarak) - Koordinat dÃ¼zeltmesi uygulandÄ±
        var vehicleIcon = L.divIcon({
            html: '<div style="font-size: 24px; transform: rotate(0deg);">â›µ</div>',
            className: 'vessel-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 15] // âœ… TAM MERKEZ - Koordinat doÄŸruluÄŸu iÃ§in dÃ¼zeltildi
        });

        // QWebChannel'Ä± hemen baÅŸlat
        new QWebChannel(qt.webChannelTransport, function (channel) {
            window.py_bridge = channel.objects.py_bridge;

            // Python'dan gelen araÃ§ pozisyonu gÃ¼ncellemesini dinle
            py_bridge.updateVehiclePosition.connect(function(lat, lng, heading) {
                if (!vehicleMarker) {
                    vehicleMarker = L.marker([lat, lng], {icon: vehicleIcon}).addTo(map);
                }
                vehicleMarker.setLatLng([lat, lng]);
                
                // Ä°konu aracÄ±n yÃ¶nÃ¼ne gÃ¶re dÃ¶ndÃ¼r - dÃ¼zeltilmiÅŸ
                var iconElement = vehicleMarker._icon.firstChild;
                if (iconElement) {
                    iconElement.style.transform = `rotate(${heading + 90}deg)`;
                }

                // Sadece ilk baÄŸlantÄ±da veya autoFollow aktifse haritayÄ± takip et
                if (firstConnection || autoFollow) {
                    map.panTo([lat, lng]);
                    if (firstConnection) {
                        map.setView([lat, lng], 15); // Ä°lk baÄŸlantÄ±da zoom yap
                        firstConnection = false;
                    }
                }
            });

            // Python'dan gelen waypoint ekleme sinyalini dinle
            py_bridge.addWaypoint.connect(function(lat, lng) {
                addWaypointMarker(lat, lng);
            });

            // Python'dan gelen haritayÄ± temizle sinyalini dinle
            py_bridge.clearMap.connect(function() {
                clearAll();
            });
        });

        // Haritaya Ã§ift tÄ±klandÄ±ÄŸÄ±nda Python'a haber ver
        map.on('dblclick', function(e) {
            if (window.py_bridge) {
                window.py_bridge.add_waypoint_to_ui(e.latlng.lat, e.latlng.lng);
            }
        });

        // KullanÄ±cÄ± haritayÄ± hareket ettirirse otomatik takibi kapat
        map.on('dragstart', function(e) {
            autoFollow = false;
        });

        // KullanÄ±cÄ± zoom yaparsa otomatik takibi kapat
        map.on('zoomstart', function(e) {
            autoFollow = false;
        });

        // SaÄŸ tÄ±k menÃ¼sÃ¼ iÃ§in context menu ekle
        map.on('contextmenu', function(e) {
            var menu = document.createElement('div');
            menu.style.position = 'fixed';
            menu.style.left = e.originalEvent.clientX + 'px';
            menu.style.top = e.originalEvent.clientY + 'px';
            menu.style.backgroundColor = 'white';
            menu.style.border = '1px solid #ccc';
            menu.style.borderRadius = '4px';
            menu.style.padding = '8px';
            menu.style.zIndex = '1000';
            menu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            menu.style.fontSize = '14px';
            menu.style.cursor = 'pointer';
            
            if (vehicleMarker && autoFollow) {
                menu.innerHTML = 'ğŸ”“ Serbest Kamera';
                menu.onclick = function() {
                    autoFollow = false;
                    document.body.removeChild(menu);
                };
            } else if (vehicleMarker) {
                menu.innerHTML = 'ğŸ”’ AracÄ± Takip Et';
                menu.onclick = function() {
                    autoFollow = true;
                    map.panTo(vehicleMarker.getLatLng());
                    document.body.removeChild(menu);
                };
            } else {
                menu.innerHTML = 'ğŸ“ AraÃ§ baÄŸlantÄ±sÄ± yok';
                menu.onclick = function() {
                    document.body.removeChild(menu);
                };
            }
            
            document.body.appendChild(menu);
            
            // BaÅŸka yere tÄ±klanÄ±nca menÃ¼yÃ¼ kapat
            setTimeout(function() {
                document.addEventListener('click', function closeMenu() {
                    if (document.body.contains(menu)) {
                        document.body.removeChild(menu);
                    }
                    document.removeEventListener('click', closeMenu);
                }, 100);
            }, 100);
        });

        // Haritaya bir waypoint markeri ekleyen fonksiyon
        function addWaypointMarker(lat, lng) {
            var waypointNum = waypoints.length + 1;
            var marker = L.marker([lat, lng], {
                title: "Waypoint " + waypointNum,
                draggable: false 
            }).addTo(map);
            
            marker.bindPopup("Waypoint " + waypointNum + "<br><small>Ã‡ift tÄ±klayarak silin</small>");
            
            // Waypoint'e Ã§ift tÄ±klandÄ±ÄŸÄ±nda sil
            marker.on('dblclick', function(e) {
                removeWaypoint(marker);
                e.originalEvent.stopPropagation(); // Harita event'inin tetiklenmesini engelle
            });
            
            waypoints.push(marker);
            updateMissionPath();
        }

        // Waypoint silme fonksiyonu
        function removeWaypoint(markerToRemove) {
            var index = waypoints.indexOf(markerToRemove);
            if (index > -1) {
                map.removeLayer(markerToRemove);
                waypoints.splice(index, 1);
                updateMissionPath();
                
                // Python tarafÄ±na waypoint silindiÄŸini bildir
                if (window.py_bridge) {
                    window.py_bridge.remove_waypoint_from_ui(index);
                }
                
                // Waypoint numaralarÄ±nÄ± yeniden dÃ¼zenle
                waypoints.forEach(function(wp, i) {
                    wp.setPopupContent("Waypoint " + (i + 1) + "<br><small>Ã‡ift tÄ±klayarak silin</small>");
                    wp.options.title = "Waypoint " + (i + 1);
                });
            }
        }

        // Waypoint'ler arasÄ±na Ã§izgi Ã§izen fonksiyon
        function updateMissionPath() {
            if (missionPath) {
                map.removeLayer(missionPath);
            }
            var latlngs = waypoints.map(wp => wp.getLatLng());
            if (latlngs.length > 1) {
                missionPath = L.polyline(latlngs, {color: 'blue'}).addTo(map);
            }
        }
        
        // TÃ¼m rotayÄ± temizleyen fonksiyon (Python'dan Ã§aÄŸrÄ±labilir)
        function clearAll() {
            if (missionPath) {
                map.removeLayer(missionPath);
                missionPath = null;
            }
            waypoints.forEach(function(wp) {
                map.removeLayer(wp);
            });
            waypoints = [];
        }
    </script>
</body>
</html>